function simulateKey(e){var t=(e=e||{}).key||"Enter",n=e.code||t,o=e.keyCode||13,i=e.delay||80,s=e.target||document;function r(e){var i=new KeyboardEvent(e,{key:t,code:n,bubbles:!0,cancelable:!0});return Object.defineProperty(i,"keyCode",{get:function(){return o}}),Object.defineProperty(i,"which",{get:function(){return o}}),i}s&&"function"==typeof s.dispatchEvent&&(s.dispatchEvent(r("keydown")),setTimeout((function(){s.dispatchEvent(r("keyup"))}),i))}const elements={header:document.getElementById("header-title"),status:document.getElementById("status-message"),romList:document.getElementById("rom-list-container"),fileInput:document.getElementById("rom_load_from_device"),canvas:document.getElementById("emulator_target")};function showView(e){document.querySelectorAll(".view-section").forEach((e=>e.classList.add("hidden")));const t=document.getElementById("view-"+e);if(t)if(t.classList.remove("hidden"),"emulator"!==e){const e=t.querySelector('[tabindex="0"]');e&&setTimeout((()=>e.focus()),50)}else elements.canvas.focus()}function resumeEmulator(){showView("emulator"),window.IodineGUI&&window.IodineGUI.Iodine&&window.IodineGUI.Iodine.play()}function waitForIodine(e){window.IodineGUI&&window.IodineGUI.Iodine?e():setTimeout((()=>waitForIodine(e)),200)}function attachBIOS(e){waitForIodine((()=>{try{IodineGUI.Iodine.attachBIOS(new Uint8Array(e))}catch(e){}}))}function attachROM(e,t){waitForIodine((()=>{try{IodineGUI.Iodine.attachROM(new Uint8Array(e)),elements.header.textContent=t||"Game Running",elements.status.textContent="",setTimeout((()=>{IodineGUI.Iodine.play(),showView("emulator")}),100)}catch(e){elements.status.textContent="Invalid ROM File"}}))}function loadRomFromBlob(e,t){if(!e)return;elements.status.textContent="Loading "+t+"...";const n=new FileReader;n.onloadend=function(){attachROM(this.result,t)},n.readAsArrayBuffer(e)}function loadRomFromUrl(e,t){elements.status.textContent="Downloading...",showView("emulator");const n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){200===n.status?loadRomFromBlob(new Blob([n.response]),t):elements.status.textContent="Download Failed"},n.onerror=function(){elements.status.textContent="Network Error"},n.send()}function fetchRomList(){const e=new XMLHttpRequest;e.open("GET","roms.json",!0),e.responseType="json",e.onload=function(){if(200===e.status){const t=e.response;elements.romList.innerHTML="",t&&t.length>0?t.forEach((e=>{const t=document.createElement("div");t.className="nav-item flex items-center px-2 py-1 rounded focus:bg-cm-focus focus:font-bold border-b border-gray-800 cursor-pointer",t.tabIndex=0,t.innerHTML=`<span class="text-[11px] cm-qvga:text-[16px] truncate">${e.name}</span>`,t.addEventListener("click",(()=>loadRomFromUrl(e.url,e.name))),elements.romList.appendChild(t)})):elements.romList.innerHTML='<div class="px-2 text-gray-500">No ROMs in json</div>'}},e.onerror=function(){elements.romList.innerHTML='<div class="px-2 text-red-500">Failed to load list</div>'},e.send()}document.addEventListener("keydown",(function(e){const t=document.activeElement;let n="emulator";if(document.querySelectorAll(".view-section").forEach((e=>{e.classList.contains("hidden")||(n=e.id.replace("view-",""))})),"Escape"===e.key||"F1"===e.key)if(e.preventDefault(),"emulator"===n)showView("menu");else if("settings"===n){const e=t.querySelector('input[type="checkbox"]');e&&e.click()}else"help"===n||"about"===n?showView("menu"):t.click();if("SoftRight"!==e.key&&"F2"!==e.key&&"Backspace"!==e.key||(e.preventDefault(),"emulator"!==n?"menu"===n?window.close():showView("menu"):showView("roms")),"Enter"===e.key&&"emulator"!==n){e.preventDefault(),t.click();const n=t.querySelector('input[type="checkbox"]');n&&n.click()}if(["ArrowUp","ArrowDown"].includes(e.key)&&"emulator"!==n){e.preventDefault();const o=Array.from(document.querySelectorAll(`#view-${n} [tabindex="0"]`)),i=o.indexOf(t);let s=i;"ArrowDown"===e.key&&(s=Math.min(i+1,o.length-1)),"ArrowUp"===e.key&&(s=Math.max(i-1,0)),o[s]&&o[s].focus()}})),window.addEventListener("load",(function(){window.innerWidth<=130&&(elements.canvas.style.cssText="width: 128px !important; height: 85px !important; object-fit: contain;");const e=new XMLHttpRequest;e.open("GET","gba_bios.bin",!0),e.responseType="arraybuffer",e.onload=function(){200===this.status&&attachBIOS(this.response)},e.send(),elements.fileInput&&elements.fileInput.addEventListener("change",(function(e){e.target.files.length>0&&loadRomFromBlob(e.target.files[0],e.target.files[0].name)})),fetchRomList(),showView("menu")})),window.addEventListener("back",(function(e){e.preventDefault(),simulateKey({key:"F2",code:"F2",keyCode:113,target:document.body})}));
